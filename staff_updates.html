<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Updates Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .conditional-field {
             display: none;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <header class="mb-8">
            <h1 class="text-3xl font-bold text-gray-900">Staff Updates Panel</h1>
            <p class="text-gray-600 mt-1">Send broadcast messages to staff members.</p>
        </header>

        <div class="max-w-2xl mx-auto bg-white p-6 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4 border-b pb-3">Compose New Update</h2>
            <form id="sendUpdateForm" class="space-y-6">
                
                <div>
                    <label for="sendTo" class="block text-sm font-medium text-gray-700">Send To</label>
                    <select id="sendTo" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2 bg-indigo-50 font-semibold">
                        <option value="all">All Staff</option>
                        <option value="department">Specific Department</option>
                        <option value="designation">Specific Designation</option>
                    </select>
                </div>

                <div id="departmentField" class="conditional-field">
                    <label for="departmentName" class="block text-sm font-medium text-gray-700">Department</label>
                    <select id="departmentName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2"></select>
                </div>

                <div id="designationField" class="conditional-field">
                    <label for="designationName" class="block text-sm font-medium text-gray-700">Designation</label>
                    <select id="designationName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2">
                        <option value="">-- Select Department First --</option>
                    </select>
                </div>

                <div>
                    <label for="updateMessage" class="block text-sm font-medium text-gray-700">Message</label>
                    <textarea id="updateMessage" rows="6" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm p-2" placeholder="Type your announcement here..."></textarea>
                </div>

                <div class="pt-4 border-t">
                    <button type="submit" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-base font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                        Send Update
                    </button>
                </div>
            </form>
             <div id="statusMessage" class="mt-4 p-4 rounded-md text-sm text-center"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDXAxfC9xpob8wEkN5chch6uiLM37L4sCo",
            authDomain: "soul-53b2d.firebaseapp.com",
            projectId: "soul-53b2d",
            storageBucket: "soul-53b2d.firebasestorage.app",
            messagingSenderId: "511225275078",
            appId: "1:511225275078:web:7b416a9debd2f579cdadc7",
            measurementId: "G-L4FJ0N6SDQ"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // DOM Elements
        const sendUpdateForm = document.getElementById('sendUpdateForm');
        const sendToSelect = document.getElementById('sendTo');
        const departmentField = document.getElementById('departmentField');
        const departmentSelect = document.getElementById('departmentName');
        const designationField = document.getElementById('designationField');
        const designationSelect = document.getElementById('designationName');
        const statusMessage = document.getElementById('statusMessage');

        const departments = {
            "Projects": "dept_proj_001", "Systems & Operations": "dept_sysop_002",
            "Health, Safety & HR": "dept_hshr_003", "Legal & Compliance": "dept_legal_004",
            "Depot & Maintenance": "dept_depot_005", "Finance & Accounts": "dept_fin_001"
        };
        const designationsByDept = {
            "Projects": ["Site Engineer (Civil)", "Site Engineer (Electrical)", "Site Engineer (Mechanical)", "Draftsman / CAD Operator", "Surveyor", "Safety Officer", "Project Assistant"],
            "Systems & Operations": ["Station Controller (SC)", "Train Operator (TO)", "Signal & Telecom Technician", "Electrical Maintainer", "Mechanical Maintainer", "Incident Reporter / Duty Staff"],
            "Health, Safety & HR": ["Safety Inspector", "Training Assistant", "HR Assistant"],
            "Legal & Compliance": ["Legal Assistant", "Documentation Clerk"],
            "Depot & Maintenance": ["Depot Technician", "Rolling Stock Maintainer", "Workshop Assistant"],
            "Finance & Accounts": ["Accounts Officer"]
        };

        function populateDropdown(selectElement, options, includeDefault = true) {
            selectElement.innerHTML = '';
            if (includeDefault) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = `-- Select ${selectElement.id.includes('department') ? 'Department' : 'Designation'} --`;
                selectElement.appendChild(defaultOption);
            }
            options.forEach(opt => {
                const option = document.createElement('option');
                option.value = opt;
                option.textContent = opt;
                selectElement.appendChild(option);
            });
        }
        
        function initializePanel() {
            populateDropdown(departmentSelect, Object.keys(departments));

            sendToSelect.addEventListener('change', (e) => {
                const target = e.target.value;
                departmentField.style.display = 'none';
                designationField.style.display = 'none';

                if (target === 'department') {
                    departmentField.style.display = 'block';
                } else if (target === 'designation') {
                    departmentField.style.display = 'block';
                    designationField.style.display = 'block';
                }
            });

            departmentSelect.addEventListener('change', (e) => {
                 const selectedDept = e.target.value;
                 populateDropdown(designationSelect, designationsByDept[selectedDept] || [], true);
            });
        }
        initializePanel();

        function showStatus(message, type = 'info') {
            statusMessage.textContent = message;
            statusMessage.className = 'p-4 rounded-md text-sm text-center';
            const colors = { success: 'bg-green-100 text-green-800', error: 'bg-red-100 text-red-800', info: 'bg-blue-100 text-blue-800' };
            statusMessage.classList.add(...(colors[type] || colors.info).split(' '));
            setTimeout(() => {
                statusMessage.textContent = '';
                statusMessage.className = 'mt-4 p-4 rounded-md text-sm text-center';
            }, 5000);
        }

        sendUpdateForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showStatus('Sending update...', 'info');

            const target = sendToSelect.value;
            const department = departmentSelect.value;
            const designation = designationSelect.value;
            const message = document.getElementById('updateMessage').value;

            if (!message.trim()) {
                showStatus('Message cannot be empty.', 'error');
                return;
            }

            let collectionPath = '';
            let targetDescription = 'All Staff';

            switch (target) {
                case 'all':
                    collectionPath = 'users/staffs/broadcast_messages';
                    break;
                case 'department':
                    if (!department) {
                        showStatus('Please select a department.', 'error');
                        return;
                    }
                    collectionPath = `users/staffs/departments/${department}/broadcast_messages`;
                    targetDescription = `Department: ${department}`;
                    break;
                case 'designation':
                    if (!department || !designation) {
                        showStatus('Please select a department and designation.', 'error');
                        return;
                    }
                    collectionPath = `users/staffs/departments/${department}/designations/${designation}/broadcast_messages`;
                    targetDescription = `Designation: ${designation} (${department})`;
                    break;
            }

            try {
                const messageData = {
                    message: message,
                    sentBy: 'super_admin_panel',
                    sentAt: serverTimestamp(),
                    target: targetDescription
                };
                
                await addDoc(collection(db, collectionPath), messageData);
                
                showStatus(`Update sent successfully to ${targetDescription}!`, 'success');
                sendUpdateForm.reset();
                // Hide conditional fields after reset
                departmentField.style.display = 'none';
                designationField.style.display = 'none';

            } catch (error) {
                console.error("Error sending update:", error);
                showStatus(`Error: ${error.message}`, 'error');
            }
        });
    </script>
</body>
</html>
